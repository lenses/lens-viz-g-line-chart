<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../google-chart/google-chart.html">
<link rel="import" href="../lens-u-data-utility/lens-u-data-utility.html">
<link rel="import" href="../lens-u-data-selector/lens-u-data-selector.html">

<!--
Element providing a Thelma wrapper for the Google Line Chart.

##### Example

    <lens-viz-g-line-chart></lens-viz-g-line-chart>

@element lens-viz-g-line-chart
@blurb Element providing a Thelma wrapper for the Google geochart.
@status alpha
@homepage http://nishacodes.github.io/lens-viz-g-line-chart
-->

<dom-module id="lens-viz-g-line-chart" attributes="selectedLabel selectedValues backgroundColor legend showOptions chartTitle gridlines orientation yAxisMin yAxisMax textColor fontSize hAxisTitle vAxisTitle gridlinesColor numberPattern">
  <template> 
    <link rel="stylesheet" href="lens-viz-g-line-chart.css">
    <lens-u-data-utility id="utility"></lens-u-data-utility>
    <lens-u-data-selector id="data_selector" input="{{input}}" style="display: {{showOptions | displayFilter}}; height: 10%;"></lens-u-data-selector>
    <google-chart id="googleChart" style="width:100%; height: {{showOptions | heightFilter}};"
          type='line'
          options= "{{options}}"
          data="{{_data}}"
          numberFormats="{{numberFormats}}">
    </google-chart>
  </template>

  <script>

    Polymer({

      properties: {
        input: {
          type: Array,
          value: [
                    {"Year": "2014", "Sales": 100, "Profit": 50},
                    {"Year": "2015", "Sales": 50, "Profit": 40},
                    {"Year": "2016", "Sales": 300, "Profit": 200}
          ],
          observer: '_inputChanged'
        },
        labelValueSelection: {
          type: Array,
          value: ['','']
        }
      },
/*
      legend: true,
      labelValueSelection: null,
      showOptions: true,
      numberPattern: "",
      gridlines: 5,
      orientation: 'horizontal',
      observe: {
        legend: "updateOptions",
        fontSize: "updateOptions",
        backgroundColor: "updateOptions",
        textColor: "updateOptions",
        vAxisTitle: "updateOptions",
        hAxisTitle: "updateOptions",
        orientation: "updateOptions",
        gridlines: "updateOptions",
        gridlinesColor: "updateOptions",
        chartTitle: "updateOptions",
        yAxisMin: "updateOptions",
        yAxisMax: "updateOptions",
        numberPattern:  "updateData",
        _numberPattern:  "updateOptions"
      },
      /*
      init: function() {
        this.inputChanged();
      },  
      */ 
      ready : function() {
        this.reformatData();
        this.updateOptions();

         // Listen for theme changes
        // document.addEventListener('th-theme-changed', function(e) {
        //   this.getColors();
        //   this.updateOptions();
        // }.bind(this));

        this.$.data_selector.addEventListener('lens-selection-changed', function() {

          this.labelValueSelection = this.$.data_selector.selections;

          this.selectedLabel = this.labelValueSelection[0];
          this.selectedValues = this.labelValueSelection[1];

          this.reformatData();

        }.bind(this));
        
      },

      _inputChanged: function () {
        var self = this;
        self.input = self.input;

        if(self.input && self.input.length>0) {

          self.dataAttributes = Object.keys(self.input[0]);
          //self.getDefaultSelections();
          self.reformatData();
          self._configureOptions();

        }
        
      },

      selectedLabelChanged: function() {
          //if selectedLabel changed from outside, set the internal data_selector
          this.$.data_selector.selections[0] = this.selectedLabel;

      },

      selectedValuesChanged: function() {
          //if selectedValue changed from outside, set the internal data_selector
          this.$.data_selector.selections[1] = this.selectedValues;

      },

 
      /**
       * 'reformatData' converts input into the correct data structure for the map
       */
      reformatData: function(){
        var self = this; 

        if(!self.labelValueSelection || !self.labelValueSelection[0] || !self.labelValueSelection[1]) {
          return;
        }
        var firstRow = self.labelValueSelection[1].map(function(item){ return item;}) ;
        
        var tmpData = self.input.map(function(item, index){
          var row = [];
          row.push(item[self.labelValueSelection[0]]);
          for(var i=0; i<self.labelValueSelection[1].length; i++){
            if (index === 0){
              // Extract the number format of the first row of data and apply to tooltips
              var format = self.$.utility.extractNumberFormat(item[self.labelValueSelection[1][i]]);
              if (format){
                self._numberPattern = format.pattern; // Use this pattern to apply to axis numbers 
                self.numberFormats.push({col: i + 1, prefix: format.prefix, suffix: format.suffix, groupingSymbol:',', fractionDigits: format.decimalPlaces});
              }
            }
            var unformattedValue = self.$.utility.unformatString(item[self.labelValueSelection[1][i]]);
            row.push(unformattedValue);
          }
          return row;
        });

        firstRow.unshift(self.labelValueSelection[0]);
        tmpData.unshift(firstRow);

        // If a specific number pattern is given, override the default pattern extracted from values
        if (self.numberPattern){
          self.numberFormats = [];
          firstRow.forEach(function(item, index){
            self.numberFormats.push({col: index, pattern: self.numberPattern});
          })  
        }

        self._data = tmpData;
      },
      updateData: function() {
        this.reformatData();
        this.updateOptions();
      },
      updateOptions: function(){
        this._configureOptions();
        this.$.googleChart.drawChart();
      },
      /**
       * '_configureOptions' sets the appropriate options properties for the map, given the attribute values
       */
      _configureOptions: function(){
        var self = this,
            colors =  self.getColors();
        
        var fgColor = self.textColor || colors.theme.foreground1 || "black";
        var bgColor = self.backgroundColor || colors.theme.background || "none";

        self.minValue = self.minValue || 0;
        // Define chart options 
        self.options = {
          title: self.chartTitle,
          titleTextStyle: { color: fgColor, fontName: colors.theme.font, fontSize: self.fontSize*1.5},
          fontSize: self.fontSize,
          orientation: self.orientation,
          colors: colors.accents,
          backgroundColor: bgColor,
          animation: {duration: "500"},
          legend: { 
            position: "bottom",
            alignment: "center",
            textStyle: { 
              color: fgColor, 
              fontName: colors.theme.font, 
              fontSize: '0.85em',
              stroke: 'none',
              strokeWidth: '0'           
            } 
          },
          vAxis: {
            title: self.vAxisTitle,
            titleTextStyle: { color: fgColor, fontName: colors.theme.font, fontSize: self.fontSize*1.25},
            baselineColor: fgColor,
            format: self.numberPattern || self._numberPattern || "#,###.##", // numberPattern is exposed as an attribute and _numberPattern is 
            gridlines: {
              count: self.gridlines,
              color: self.gridlinesColor || fgColor
            },
            textStyle:{ color: fgColor, fontName: colors.theme.font, fontSize: '0.85em'},
            minValue: self.orientation === "horizontal" ? self.yAxisMin : "automatic",
            maxValue: self.orientation === "horizontal" ? self.yAxisMax : "automatic",
          },
          hAxis: {
            title: self.hAxisTitle,
            titleTextStyle: { color: fgColor, fontName: colors.theme.font, fontSize: self.fontSize*1.25},
            baselineColor: fgColor,
            textStyle:{ color: fgColor, fontName: colors.theme.font, fontSize: '0.85em'},
            format: self.numberPattern || self._numberPattern || "#,###.##", // numberPattern is exposed as an attribute and _numberPattern is 
            gridlines: {
              count: self.gridlines,
              color: self.gridlinesColor || fgColor
            },
            minValue: self.orientation === "vertical" ? self.yAxisMin : "automatic",
            maxValue: self.orientation === "vertical" ? self.yAxisMax : "automatic",
          }
        };

        if (!self.legend) { self.options.legend = 'none';}
      },
      /**
       * 'getColors' gets the color theme from the global scope
       * @return {Object}
       */
      getColors: function(){
        colors = {};
        /*
        colors.theme = window.CoreStyle.g.theme;
        colors.accents = [];

        for (var color in colors.theme){
          if(/^accent/.test(color)){
            colors.accents.push(colors.theme[color]);
          }
        }
        */

        colors['theme'] = {
            foreground1: '#2B2B2B',
            foreground2: '#FFFFFF',
            background: '#FFFFFF',
            accent0: '#3AA5DD',
            accent1: '#52B64F',  
            accent2: '#F2673A',  
            accent3:'#454A50',  
            accent4: '#969696',  
            accent5: '#F6F7F7',  
            accent6: '#51574a',
            accent7: '#447c69',
            accent8: '#74c493',
            accent9: '#8e8c6d',
            accent10: '#e4bf80',
            accent11: '#e9d78e',
            accent12: '#e2975d',
            accent13: '#f19670',
            accent14: '#e16552',
            accent15: '#c94a53',
            accent16: '#be5168',
            accent17: '#a34974',
            accent18: '#993767',
            accent19: '#65387d',
            accent20: '#4e2472',
            accent21: '#9163b6',
            accent22: '#e279a3',
            accent23: '#e0598b',
            accent24: '#7c9fb0',
            accent25: '#5698c4',
            accent26: '#9abf88',
            font: "'proxima-nova', sans-serif",
            serifFont: "'Chronicle Display', 'Times Roman', 'Times New Roman', Georgia, serif",
            sansSerifFont: "'proxima-nova', sans-serif",
            mapColors: ['rgb(239,243,255)','rgb(198,219,239)','rgb(158,202,225)','rgb(107,174,214)','rgb(66,146,198)','rgb(33,113,181)','rgb(8,69,148)']
        };
        colors.accents = Object.keys(colors.theme).filter(function(key) {
            return key.indexOf('accent')>-1;
          })
          .map(function(key) {
            return colors.theme[key];
          });

        colors.count = colors.accents.length;//colors.accents.length;

        return colors;
      },
      resize: function() {
        this.$.googleChart.drawChart();
      },
      displayFilter: function(value){
        return value ? "inline-block" : "none";
      },
      heightFilter: function(value){
        return value ? "90%" : "100%";
      }


    });

  
  </script>

</dom-module>
